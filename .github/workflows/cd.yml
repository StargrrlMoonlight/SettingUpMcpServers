name: Continuous Deployment

on:
  workflow_run:
    workflows: ["Continuous Integration"]
    branches: [main]
    types:
      - completed

permissions:
  contents: read
  pages: write
  id-token: write
  actions: write  # Needed to trigger release workflow

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
# However, do NOT cancel in-progress runs as we want to allow these production deployments to complete.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Build job - Creates artifacts for both staging and production
  build:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Build application
        run: npm run build
        
      - name: Upload staging build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: staging-build
          path: dist/
          retention-days: 1
          
      - name: Upload production build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: production-build
          path: dist/
          retention-days: 7

  # Staging deployment - Preview deployment for testing
  deploy-staging:
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: staging
      url: "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
    steps:
      - name: Download staging build artifacts
        uses: actions/download-artifact@v4
        with:
          name: staging-build
          path: ./dist
          
      - name: Staging validation
        run: |
          echo "🏗️ Staging validation complete!"
          echo "📍 Staging Environment: GitHub Actions Preview"
          echo "🔍 Build artifacts validated for staging environment"
          echo "✅ Ready for production deployment approval"
          
          # Validate build artifacts
          if [ ! -f "./dist/index.html" ]; then
            echo "❌ Missing index.html in build artifacts"
            exit 1
          fi
          
          echo "✅ Staging validation passed!"

  # Production deployment - Deploy to GitHub Pages (our live site)
  deploy-production:
    runs-on: ubuntu-latest
    needs: [build, deploy-staging]
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: "https://stargrrlmoonlight.github.io/SettingUpMcpServers"
    permissions:
      pages: write
      id-token: write
    steps:
      - name: Download production build artifacts
        uses: actions/download-artifact@v4
        with:
          name: production-build
          path: ./dist
          
      - name: Setup Pages
        uses: actions/configure-pages@v4
        
      - name: Upload pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist
          
      - name: Deploy to GitHub Pages (Production)
        id: deployment
        uses: actions/deploy-pages@v4
        
      - name: Production Health Check
        run: |
          echo "🚀 Production deployment complete!"
          echo "📍 Production URL: ${{ steps.deployment.outputs.page_url }}"
          
          # Basic health check
          echo "Performing production health check..."
          sleep 15
          
          if curl -f -s "${{ steps.deployment.outputs.page_url }}" > /dev/null; then
            echo "✅ Production health check passed!"
          else
            echo "⚠️ Production site may not be ready yet (this is normal for GitHub Pages)"
          fi

  # Release trigger - Create formal release after successful production deployment  
  trigger-release:
    runs-on: ubuntu-latest
    needs: [build, deploy-staging, deploy-production]
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Determine release version
        id: version
        run: |
          # Get the latest tag to determine next version
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "Latest tag: $LATEST_TAG"
          
          # Extract version number without 'v' prefix
          VERSION=$(echo $LATEST_TAG | sed 's/^v//')
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
          
          # Check commit messages since last tag for semantic versioning
          if [ "$LATEST_TAG" = "v0.0.0" ]; then
            # First release
            NEW_VERSION="v1.0.0"
          else
            # Increment based on conventional commits
            if git log ${LATEST_TAG}..HEAD --oneline | grep -q "BREAKING CHANGE\\|feat!"; then
              # Major version bump
              NEW_VERSION="v$((MAJOR + 1)).0.0"
            elif git log ${LATEST_TAG}..HEAD --oneline | grep -q "feat\\|feature"; then
              # Minor version bump
              NEW_VERSION="v${MAJOR}.$((MINOR + 1)).0"
            else
              # Patch version bump (for fixes, docs, etc.)
              NEW_VERSION="v${MAJOR}.${MINOR}.$((PATCH + 1))"
            fi
          fi
          
          echo "next_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "🎯 Next release version: $NEW_VERSION"
          
      - name: Trigger Release Workflow
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            console.log('🚀 Triggering Release workflow...');
            
            const result = await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'release.yml',
              ref: 'main',
              inputs: {
                version: '${{ steps.version.outputs.next_version }}',
                prerelease: 'false',
                triggered_by_cd: 'true'
              }
            });
            
            console.log('✅ Release workflow triggered successfully!');
            console.log('📦 Release version: ${{ steps.version.outputs.next_version }}');
            
      - name: Release workflow complete
        run: |
          echo "🎉 Release workflow triggered successfully!"
          echo "📍 Production URL: https://stargrrlmoonlight.github.io/SettingUpMcpServers"
          echo "🎯 Release workflow has been triggered"
          echo "📦 Expected release version: ${{ steps.version.outputs.next_version }}"
          echo "⏳ Release creation in progress..."
